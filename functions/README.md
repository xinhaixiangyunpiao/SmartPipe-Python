# Profile

# Image
### 读取图片
- opencv 单线程从视频流读取
    | resolution ratio | count | time  | average |  fps  |
    | ---------------- | ----- | ----- | ------- | ----- |
    |  4k(3840*2160)   |  839  | 17.8s | 21.2ms  | 47.2  |
    | 1080p(1920*1080) |  839  | 9.02s | 10.8ms  | 92.6  |
    |  720p(1280*720)  |  839  | 8.35s | 9.95ms  | 100.5 | 
    |  540p(960*540)   |  839  | 8.37s | 9.98ms  | 100.2 |

- 结论：4k的视频读取有可能成为性能瓶颈，1080p的读取及以下大概率不会成为瓶颈，且opencv单进程读取有效率上限，上限大概在100fps左右。

### 传输图片
- 传输时延 - 两进程单队列
    - 4k (3840*2160)
        | count | start |  end   |  cost  | average  |
        | ----- | ----- | ------ | ------ | -------- |
        |  10   | 9.630 | 10.739 | 1.109s | 110.9ms  |
        |  10   | 8.630 | 9.737  | 1.107s | 110.7ms  |
        |  10   | 7.630 | 8.614  | 0.984s |  98.4ms  |
        |  10   | 6.630 | 7.591  | 0.961s |  96.1ms  |
        |  10   | 5.630 | 6.625  | 0.996s |  99.5ms  |
        |  10   | 4.630 | 5.559  | 0.929s |  92.9ms  |
    
    - 1080p (1920*1080)
        | count | start |  end   |  cost  | average  |
        | ----- | ----- | ------ | ------ | -------- |
        |  10   | 9.378 | 10.393 | 1.015s | 101.5ms  |
        |  10   | 8.378 | 9.424  | 1.046s | 104.6ms  |
        |  10   | 7.378 | 8.374  | 0.996s |  99.6ms  |
        |  10   | 6.378 | 7.422  | 1.044s | 104.4ms  |
        |  10   | 5.378 | 6.358  | 0.980s |  98.0ms  |
        |  10   | 4.378 | 5.572  | 1.194s | 119.4ms  |
    
    - 720p (1280*720)
        | count | start |  end   |  cost  | average |
        | ----- | ----- | ------ | ------ | ------- |
        |  10   | 3.488 | 3.791  | 0.303s | 30.3ms  |
        |  10   | 2.488 | 3.113  | 0.625s | 62.5ms  |
        |  10   | 1.488 | 1.755  | 0.267s | 26.7ms  |
        |  10   | 0.488 | 0.888  | 0.400s | 40.0ms  |
        |  10   | 9.488 | 10.002 | 0.514s | 51.4ms  |
        |  10   | 8.488 | 8.941  | 0.453s | 45.3ms  |

    - 540p (960*540)
        | count | start |  end  |  cost  | average |
        | ----- | ----- | ----- | ------ | ------- |
        |  10   | 9.167 | 9.502 | 0.335s | 33.5ms  |
        |  10   | 8.167 | 8.558 | 0.391s | 39.1ms  |
        |  10   | 7.167 | 7.399 | 0.232s | 23.2ms  |
        |  10   | 6.167 | 6.526 | 0.359s | 35.9ms  |
        |  10   | 5.167 | 5.460 | 0.293s | 29.3ms  |
        |  10   | 4.167 | 4.546 | 0.379s | 37.9ms  |
 
    - 图片大小为4k和1080p时，每一级pipe大概会造成100ms的时延损失。

- 从队列中获取图片
    - 4k (3840*2160)
        | count |  time  | average | fps  |
        | ----- | ------ | ------- | ---- |
        |  482  | 20.14s | 41.8ms  | 23.9 |
        |  538  | 22.27s | 41.4ms  | 24.2 |
        |  540  | 23.54s | 43.6ms  | 22.9 |
        |  630  | 25.49s | 40.5ms  | 24.7 |
        |  775  | 32.15s | 41.5ms  | 24.1 |
        |  839  | 33.08s | 39.4ms  | 25.4 |

    - 1080p (1920*1080)
        | count |  time  | average | fps   |
        | ----- | ------ | ------- | ----- |
        |  512  | 4.37s  | 8.5ms   | 117.6 |
        |  586  | 7.31s  | 12.5ms  | 80.0  |
        |  701  | 8.69s  | 12.4ms  | 80.6  |
        |  839  | 8.24s  | 9.8ms   | 102.0 |
    
    - 720p (1280*720)
        | count |  time  | average |  fps  |
        | ----- | ------ | ------- | ----- |
        |  512  | 2.13s  |  4.2ms  | 238.1 | 
        |  586  | 2.42s  |  4.1ms  | 243.9 |
        |  701  | 3.13s  |  4.5ms  | 222.2 |
        |  839  | 4.26s  |  5.1ms  | 196.9 |

    - 540p (960*540)
        | count |  time  | average |  fps  |
        | ----- | ------ | ------- | ----- |
        |  482  | 1.32s  |  2.7ms  | 370.4 | 
        |  540  | 1.98s  |  3.7ms  | 272.8 |
        |  630  | 1.72s  |  2.7ms  | 370.4 |
        |  775  | 2.01s  |  2.6ms  | 384.6 |
        |  839  | 4.61s  |  5.5ms  | 181.8 |
    
    - 结论：4k的视频传输很有可能会成为性能瓶颈，1080p及一下基本不会成为瓶颈。
    - 解决方案：由于接收的操作时间与计算的时间具有可比性，可以利用流水线提前预取将其隐藏。
        - 有待测试

## 保存图片
- 保存图片到视频
    | resolution ratio | count | time  | average |  fps  |
    | ---------------- | ----- | ----- | ------- | ----- |
    |  4k(3840*2160)   |  839  | 31.3s | 37.3ms  | 26.8  |
    | 1080p(1920*1080) |  839  | 9.41s | 11.2ms  | 89.3  |
    |  720p(1280*720)  |  634  | 3.28s | 5.17ms  | 193.4 |
    |  540p(960*540)   |  839  | 2.60s | 3.10ms  | 322.6 |

- 结论：4k的save操作会成为瓶颈，1080p及以下save操作大概率不会成为瓶颈。

## Resize
- (3840\*2160) -> (1920\*1080)
    | count |  time  | average |  fps  |
    | ----- | ------ | ------- | ----- |
    |  634  | 1.230s |  1.9ms  | 526.3 |
    |  839  | 1.737s |  2.1ms  | 476.2 |
    |  839  | 2.104s |  2.5ms  | 400.0 |
    
- (3840\*2160) -> (960\*540)
    | count |  time  | average |  fps  |
    | ----- | ------ | ------- | ----- |
    |  646  | 0.919s | 1.42ms  | 704.2 |
    |  720  | 1.103s | 1.53ms  | 653.6 |
    |  839  | 1.480s | 1.76ms  | 568.2 |

- (1920\*1080) -> (960\*540)
    | count |  time  | average | fps  |
    | ----- | ------ | ------- | ---- |
    |  749  | 0.614s | 0.82ms  | 1220 |
    |  839  | 0.741s | 0.88ms  | 1136 |
    |  839  | 0.673s | 0.80ms  | 1250 |

- 结论：图片resize操作基本不会成为性能瓶颈。


## Crop

